define("test/mobile/wechat",["jquery","common","http://res.wx.qq.com/open/js/jweixin-1.0.0.js"],function(e,n,s){"user strict";var a,i=e("jquery"),t=e("common"),o=e("http://res.wx.qq.com/open/js/jweixin-1.0.0.js"),r=-1!=navigator.userAgent.toLowerCase().indexOf("micromessenger"),c={},l=60;c.init=function(){if(i("#tipContent").length){var e=document.getElementById("tipContent");window.setInterval(function(){c.scrollup(e,40,0)},3e3)}r&&1==shareok&&c.share(),i("#show_mobile_Now").click(function(){i("#mask").css("display","block"),i("#show_mobile_binding").css("display","table")});var n=i("#show_mobile_binding");n.on({click:function(){var e=i("#mobile").val(),n=i("#actid").val();i.ajax({type:"POST",url:homeUrl+"wechat/misc/send_authcode",data:{actid:n,mobile:e},cache:!1,dataType:"json",success:function(e){200==e.code?(i("#sendCode").attr("disabled","true"),i("#sendCode").addClass("sendcodeHover"),a=window.setInterval(c.setTime,1e3)):t.showmsg(e.message,"",1e3)},error:function(){t.showmsg("数据有问题，稍后再试！","",1e3)}})}},"#sendCode"),n.on({click:function(){var e=i("#actid").val(),n=i("#mobile").val(),s=i("#authcode").val();return""==n||""==s?(t.showmsg("请输入手机号或验证码"),!1):void i.ajax({type:"POST",url:homeUrl+"wechat/misc/check_authcode",data:{actid:e,mobile:n,authcode:s},cache:!1,dataType:"json",success:function(e){200==e.code?(i("#show_mobile_binding").css("display","none"),i("#show_cart_binding").css("display","table")):t.showmsg(e.message,"",1e3)},error:function(){t.showmsg("数据有问题，稍后再试！","",1e3)}})}},"#mobile_next_cart"),i("#show_cart_Now").click(function(){i("#mask").css("display","block"),i("#show_cart_binding").css("display","table")});var s=i("#show_cart_binding"),l=parseInt(s.find("#maxbuy").text());s.on({click:function(){var e=i(this).prev();i(this).parent().find("#btn_minus i").removeClass("icon-minus-out"),c.isInt(e.val())||e.val("1");var n=parseInt(e.val())+1;n>=l&&l>0&&(i(this).find("i").addClass("icon-plus-out"),t.showmsg("您最多可购买"+l+"次！"),n=l),e.val(n),s.find(".numSL em").text(n)}},"#btn_plus"),s.on({click:function(){var e=i(this).next();i(this).parent().find("#btn_plus i").removeClass("icon-plus-out"),c.isInt(e.val())||e.val("1");var n=parseInt(e.val());return 1>n-1?(i(this).find("i").addClass("icon-minus-out"),!1):(n--,e.val(n),void s.find(".numSL em").text(n))}},"#btn_minus"),s.on({click:function(){var e=parseInt(i("#total").val()),n=parseInt(i("#actid").val()),s=i("#fromuid").val();r?i.ajax({type:"POST",url:homeUrl+"wechat/misc/order",data:{id:n,times:e},cache:!1,dataType:"json",success:function(e){200==e.code?(o.config({debug:!1,appId:shareDate.appId,timestamp:shareDate.timestamp,nonceStr:shareDate.nonceStr,signature:shareDate.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","onMenuShareWeibo","onMenuShareQZone","hideOptionMenu","showOptionMenu","chooseWXPay"]}),o.ready(function(){o.chooseWXPay({timestamp:e.data.jsApiParameters.timeStamp,nonceStr:e.data.jsApiParameters.nonceStr,"package":e.data.jsApiParameters["package"],signType:e.data.jsApiParameters.signType,paySign:e.data.jsApiParameters.paySign,appId:shareDate.appId,success:function(n){c.paytrue(e.data.orderid,s)},cancel:function(e){alert("您确定要取消支付?")},fail:function(e){alert("支付失败")}})}),o.error(function(e){alert(e.errMsg)})):t.showmsg(e.message,"",1e3)},error:function(){t.showmsg("数据有问题，稍后再试！","",1e3)}}):t.showmsg("请在微信中购买哦！亲","",1e3)}},"#cart_next_share");var d=i("#show_share_binding");d.on({click:function(){i(".download_img").css("display","block")}},"#share_next_ok"),i(".icon-close").click(function(){i(this).closest(".layer_iframe").css("display","none"),i("#mask").css("display","none"),"block"==i(".download_img").css("display")&&i(".download_img").css("display","none")})},c.luckyShare=function(){i("#lucky_share").click(function(){i("#mask").css("display","block"),i(".download_img").css("display","block")}),i("#mask").click(function(){i(".download_img").css("display","none"),i("#mask").css("display","none")})},c.scrollup=function(e,n,s){if(n==s){var a=c.getFirstChild(e.firstChild).cloneNode(!0);e.removeChild(c.getFirstChild(e.firstChild)),e.appendChild(a),a.style.marginTop="0px"}else s+=2,c.getFirstChild(e.firstChild).style.marginTop=-s+"px",window.setTimeout(function(){c.scrollup(e,n,s)},20)},c.getFirstChild=function(e){for(;1!=e.nodeType;)e=e.nextSibling;return e},c.setTime=function(){0==l?(window.clearInterval(a),i("#sendCode").removeAttr("disabled"),i("#sendCode").removeClass("sendcodeHover"),i("#sendCode").val("重新发送验证码"),l=60):(l--,i("#sendCode").val(l+"'"))},c.isInt=function(e){return/^[-\+]?\d+$/.test(i.trim(e))},c.paytrue=function(e,n){i.ajax({type:"POST",url:homeUrl+"wechat/misc/do_payment",data:{orderid:e,fromuid:n},dataType:"json",success:function(e){200==e.code?(t.showmsg("亲，支付成功！","",1e3),i("#show_cart_binding").css("display","none"),i("#show_share_binding").css("display","table"),0==shareok&&c.share()):alert(e.message)},error:function(){t.showmsg("微信支付有问题","",1e3)}})},c.share=function(){o.config({debug:!1,appId:shareDate.appId,timestamp:shareDate.timestamp,nonceStr:shareDate.nonceStr,signature:shareDate.signature,jsApiList:["onMenuShareTimeline","onMenuShareAppMessage","onMenuShareQQ","onMenuShareWeibo","onMenuShareQZone","hideOptionMenu","showOptionMenu","chooseWXPay"]}),o.ready(function(){o.showOptionMenu(),o.onMenuShareAppMessage({title:shareTitle,desc:shareDescription,link:shareUrl,imgUrl:shareImage,trigger:function(e){},success:function(e){},cancel:function(e){},fail:function(e){}}),o.onMenuShareTimeline({title:shareTitle,link:shareUrl,imgUrl:shareImage,trigger:function(e){},success:function(e){},cancel:function(e){},fail:function(e){}})}),o.error(function(e){alert(e.errMsg)})},s.exports=c});